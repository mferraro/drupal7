
if(document.images){var imgPath=geoBCN.baseURL+"js/"+geoBCN.versions.api+"/img/mapa/";var preload=geoBCN.preloadImg;if(geoBCN.esMobil){preload(imgPath+"checks.png");preload(imgPath+"sprites-general-mob.png");preload(imgPath+"crosshair.png");}else{preload(imgPath+"checks-pc.png");preload(imgPath+"sprites-general.png");}
preload(imgPath+"dropdown.png");preload(imgPath+"close-cloud.gif");preload(imgPath+"marker.png");preload(imgPath+"marker_fort.png");}
define(["proj4","OpenLayers","jquery-private",geoBCN.baseFiles+"utils"+geoBCN.suffix+".js",geoBCN.baseFiles+"controls"+geoBCN.suffix+".js",'ResizeSensor'],function(proj4,ol,jQuery,Utils,Controls,ResizeSensor){var DEFAULT_PROJECTION='EPSG:25831';if(ol.proj.proj4)ol.proj.proj4.register(proj4);var extent=[412363,4570689,445655,4592357];var resolutions=[50,25,16,8,4,2,1,0.5,0.25];var maxZoom=resolutions.length-1;var log=geoBCN.log4js.getLogger("map");var urlTilePattern="/{z}/{c1}/{c2}/{c3}/{r1}/{r2}/{r3}.png";window.ol=ol;log.addAppender(geoBCN.logAppender);if(geoBCN.trace){log.setLevel(log4javascript.Level.TRACE);}
log.debug("init module");var circles=[],steps=100,minRadius=0,maxRadius=100;function drawCircle(map,x,y){var c=[x,y,minRadius,1];circles.push(c);(function anim(t){if(t<steps){c[2]=Math.sqrt(t/steps)*maxRadius+minRadius;c[3]=1-Math.sqrt(t/steps);_.delay(anim,5,t+1);}else{circles=_.without(circles,c);}
map.requestRenderFrame();})(0);}
function styleFunction(feature,resolution,customStyle){customStyle=customStyle||{'normal':{}};customStyle.normal=customStyle.normal||{};var lineStringColor=customStyle.normal.colorLinea||'green';var lineStringWidth=customStyle.normal.gruixLinea||1;var polygonColor=customStyle.normal.colorLinea||'#6f4c26';var polygonWidth=customStyle.normal.gruixLinea||3;var polygonFill=customStyle.normal.colorEmplenat||'rgba(232,200,155, 0.3)';var polygonColor=customStyle.normal.colorLinea||'#6f4c26';var polygonWidth=customStyle.normal.gruixLinea||3;var polygonFill=customStyle.normal.colorEmplenat||'rgba(232,200,155, 0.3)';var geomCollectionColor=customStyle.normal.colorLinea||'magenta';var geomCollectionWidth=customStyle.normal.gruixLinea||2;var geomCollectionFill=customStyle.normal.colorEmplenat||'magenta';var circleColor=customStyle.normal.colorLinea||'red';var circleWidth=customStyle.normal.gruixLinea||2;var circleFill=customStyle.normal.colorEmplenat||'rgba(255,0,0,0.2)';var pointColor=customStyle.normal.colorLinea||'red';var pointWidth=customStyle.normal.gruixLinea||20;var pointFill=customStyle.normal.colorEmplenat||'red';var styles={'LineString':[new ol.style.Style({stroke:new ol.style.Stroke({color:lineStringColor,width:lineStringWidth})})],'MultiLineString':[new ol.style.Style({stroke:new ol.style.Stroke({color:lineStringColor,width:lineStringWidth})})],'MultiPolygon':[new ol.style.Style({stroke:new ol.style.Stroke({color:polygonColor,width:polygonWidth}),fill:new ol.style.Fill({color:polygonFill})})],'Polygon':[new ol.style.Style({stroke:new ol.style.Stroke({color:polygonColor,width:polygonWidth}),fill:new ol.style.Fill({color:polygonFill})})],'GeometryCollection':[new ol.style.Style({stroke:new ol.style.Stroke({color:geomCollectionColor,width:geomCollectionWidth}),fill:new ol.style.Fill({color:geomCollectionFill}),image:new ol.style.Circle({radius:10,fill:null,stroke:new ol.style.Stroke({color:geomCollectionColor})})})],'Circle':[new ol.style.Style({stroke:new ol.style.Stroke({color:circleColor,width:circleWidth}),fill:new ol.style.Fill({color:circleFill})})],'Point':[new ol.style.Style({stroke:new ol.style.Stroke({color:pointColor,width:pointWidth}),fill:new ol.style.Fill({color:pointFill})})]};return styles[feature.getGeometry().getType()];}
function redraw(map){map.updateSize();}
function creaMapa(opcions){var projection=ol.proj.get(DEFAULT_PROJECTION);projection.setExtent(extent);var mapLayers=[];if(!opcions.mapaBlanc){opcions.fons.forEach(function(element){var indexElement=configBCN.fonsMapa.map(function(e){return e.codi}).indexOf(element);var tileLayer=configBCN.fonsMapa[indexElement];if(tileLayer.tipusTile!='XYZ'){mapLayers.push(getBaseLayer(tileLayer,opcions.fons.indexOf(tileLayer.codi)==0))}else{mapLayers.push(getBaseLayerXYZ(tileLayer,opcions.fons.indexOf(tileLayer.codi)==0))}});}
var mapDiv=opcions.divContainer||document.getElementById(opcions.divId);mapDiv.className+=(mapDiv.className?" ":"")+(geoBCN.esMobil?"mobile":"");var hasHeight=window.getComputedStyle(mapDiv).height!=='0px';if(!hasHeight){mapDiv.style.height='300px';}
var sensorResizerTimeout=null;var sensor=new geoBCN.ResizeSensor(mapDiv,function(){clearTimeout(sensorResizerTimeout);sensorResizerTimeout=setTimeout(function(){map.updateSize();},10);});function mapContainerVisible(){return jQuery(mapDiv).is(':visible');}
if(!mapContainerVisible()){var checkerVisibilityMap=setInterval(function(){if(mapContainerVisible()){clearInterval(checkerVisibilityMap);redraw(map);}},300);}
var defControls=opcions.eines.indexOf("ZOOM")<0?[]:[new ol.control.Zoom({target:jQuery("#rightoverlays")[0]})];var mView=null;var centreCalculat=_calculaCentreMapa({zoom:opcions.zoom,localitzacio:opcions.centre,proj:opcions.proj});var calc={centre:centreCalculat.center?centreCalculat.center:{x:430916,y:4583697},zoom:typeof centreCalculat.zoom!='undefined'?centreCalculat.zoom:2};if(!opcions.view){mView=new ol.View({projection:projection,resolutions:opcions.resolucions||resolutions,zoom:calc.zoom,center:[calc.centre.x,calc.centre.y],rotation:opcions.rotacio*0.0174532925||0,extent:opcions.maxExtent||extent});}else{mView=opcions.view;}
var interactions=ol.interaction.defaults({altShiftDragRotate:!opcions.blocaRotacio,pinchRotate:!opcions.blocaRotacio});var map=new ol.Map({layers:mapLayers,target:opcions.divId,logo:false,controls:defControls,interactions:interactions,view:mView});log.debug("Mapa creat");return map;}
function getBaseLayer(baseLayer,isVisible){function zeroPad(num,places){var zero=places-num.toString().length+1;return(Array(+(zero>0&&zero)).join("0")+num).toString().slice(-places);};var projection=ol.proj.get(baseLayer.projeccio.codiApi);projection.setExtent([412363,4570689,445655,4592357]);return new ol.layer.Tile({preload:Infinity,visible:isVisible,id:baseLayer.codi,source:new ol.source.TileImage({crossOrigin:'anonymous',extent:[baseLayer.extentX1,baseLayer.extentY1,baseLayer.extentX2,baseLayer.extentY2],projection:projection,tileGrid:new ol.tilegrid.TileGrid({origin:[baseLayer.origenX,baseLayer.origenY],resolutions:baseLayer.resolucions}),tileUrlFunction:function(tileCoord,pixelRatio,projection){if(tileCoord[1]<0||tileCoord[2]<0){return"";}
var xPadded=zeroPad(tileCoord[1],9);var yPadded=zeroPad(tileCoord[2],9);var zPadded=zeroPad(tileCoord[0],2);var url=urlTilePattern.replace('{z}',zPadded).replace('{c1}',xPadded.slice(0,3)).replace('{c2}',xPadded.slice(3,6)).replace('{c3}',xPadded.slice(6,9)).replace('{r1}',yPadded.slice(0,3)).replace('{r2}',yPadded.slice(3,6)).replace('{r3}',yPadded.slice(6,9));return baseLayer.url+url;}})});}
function getBaseLayerXYZ(baseLayer,isVisible){var projection=new ol.proj.Projection({code:DEFAULT_PROJECTION,units:'m'});var extent=[394975.154687,4551353.328349,453678.792410,4610056.966072];var resolutions=[78271.51696402048,39135.75848201023,19567.87924100512,9783.939620502561,4891.969810251280,2445.984905125640,1222.992452562820,611.4962262814100,305.7481131407048,152.8740565703525,76.43702828517624,38.21851414258813,19.10925707129406,9.554628535647032,4.777314267823516,2.388657133911758,1.194328566955879,0.5971642834779395,0.2985821417389697,0.1492910708694849,0.0746455354347424];projection.setExtent(extent);var tileGrid=new ol.tilegrid.TileGrid({origin:[258000,4766600],extent:extent,resolutions:resolutions,minZoom:0});return new ol.layer.Tile({title:baseLayer.titol,id:baseLayer.codi,type:'base',visible:isVisible,source:new ol.source.TileImage({tileUrlFunction:function(tileCoord,pixelRatio,projection){var z=tileCoord[0];var x=tileCoord[1];var y=-tileCoord[2]-1;var n=Math.pow(2,z+1);x=x%n;if(x*n<0){x=x+n;}
return baseLayer.url.replace('{z}',z.toString()).replace('{y}',y.toString()).replace('{x}',x.toString());},projection:projection,tileGrid:tileGrid})});}
function getMarkersLayer(){var iconStyle=new ol.style.Style({image:new ol.style.Icon(({scale:1,anchorXUnits:'fraction',anchorYUnits:'fraction',anchor:[0.5,1],opacity:0.75,src:geoBCN.baseURL+'js/'+geoBCN.versions["api"]+'/img/mapa/marker.png'}))});var vectorSource=new ol.source.Vector({features:[]});var vectorLayer=new ol.layer.Vector({source:vectorSource,hideAtLegend:true,style:iconStyle});return vectorLayer;}
function getGeometriesLayer(){var vectorSource=new ol.source.Vector({features:[]});var vectorLayer=new ol.layer.Vector({source:vectorSource,hideAtLegend:true,style:styleFunction});return vectorLayer;}
function defineProjectionExtents(){log.debug("Definint les extensions de les projeccions");ol.proj.get(DEFAULT_PROJECTION).setExtent([238379.2278,4265559.3497,761620.7722,6914547.3835]);ol.proj.get('EPSG:4326').setExtent([-180.0000,-90.0000,180.0000,90.0000]);ol.proj.get('EPSG:23031').setExtent([238730.0252,4276730.7754,761269.9748,7434723.1222]);}
defineProjectionExtents();Utils.loadCSS("js/"+geoBCN.versions.api+"/jsapi.css","jsapi");Utils.loadCSS("js/lib/openlayers/css/ol-"+geoBCN.versions["ol"]+".css","cssool");function getStandardCoords(coords){try{var defProj=(typeof olMap!=="undefined"&&olMap&&olMap.getView().getProjection().getCode())||DEFAULT_PROJECTION;var finalCoords={x:null,y:null,proj:defProj};var coordX,coordY,coordProj;if(coords instanceof Array){finalCoords.x=coords[0];finalCoords.y=coords[1];}
else if(coords instanceof Object){if(coords.lat&&coords.lon){finalCoords.x=coords.lon;finalCoords.y=coords.lat;finalCoords.proj='EPSG:4326';}
else if(coords.x&&coords.y){finalCoords.x=coords.x;finalCoords.y=coords.y;if(coords.proj&&coords.proj=="GOOGLE"){finalCoords.proj='EPSG:4326';}
else{finalCoords.proj=coords.proj||defProj;}}
else{throw"El format de les coordenades no és acceptable o és incorecte";}}
if(isNaN(finalCoords.x)||isNaN(finalCoords.y)){throw"Le coordenades no son numèriques";}
if(finalCoords.proj!=defProj){finalCoords=Utils.projectaLocalitzacio(finalCoords,defProj);}
return finalCoords}
catch(e){console.warn(e);return null;}}
function _calculaCentreMapa(options,olMap){var ret={};var vector=new ol.source.Vector();var defProj=options.proj||DEFAULT_PROJECTION;var vista=null;if(olMap){vista=olMap.getView();vista.fitExtent=vista.fit||vista.fitExtent;}
if(options.extensio){ret.extent=options.extensio;}else{var punts=[];if(typeof options.localitzacio==='undefined'){options.localitzacio=[];}
else if(Array.isArray(options.localitzacio)&&!_isArrayCoord(options.localitzacio)){punts=options.localitzacio;}
else{punts.push(options.localitzacio);}
for(var i=0;i<punts.length;i++){if(!punts[i].proj&&punts[i].x&&punts[i].y){punts[i].proj=defProj;}}
var bbox=[Number.MAX_VALUE,Number.MAX_VALUE,0,0];var p;var punt;for(var i=0;i<punts.length;i++){punt=punts[i];if(punt instanceof ol.geom.Geometry){vector.addFeature(new ol.Feature({geometry:punt}));}
else{p=getStandardCoords(punt);vector.addFeature(new ol.Feature({geometry:new ol.geom.Point([p.x,p.y])}));}
bbox=vector.getExtent();}
if(options.zoom==='auto'){ret.extent=bbox;}else{if(punts.length){ret.center={x:(bbox[0]+bbox[2])/2,y:(bbox[1]+bbox[3])/2,proj:DEFAULT_PROJECTION};}
if(!isNaN(options.zoom)){ret.zoom=options.zoom;}}}
return ret;}
function _isArrayCoord(array){return typeof(array[0])==='number'&&typeof(array[1])==='number';}
function _getGeometryCoords(array){var ret=[];if(_isArrayCoord(array)){ret.push({x:array[0],y:array[1]});}else{for(var i=0;i<array.length;i++){ret=ret.concat(_getGeometryCoords(array[i]));}}
return ret;}
function _getNormalizedLocations(localitzacio){if(typeof localitzacio==='undefined'){return[];}
if(localitzacio instanceof Array){if(localitzacio.length){if(_isArrayCoord(localitzacio)){localitzacio=_getGeometryCoords(localitzacio);}else{var results=[];for(var i=0;i<localitzacio.length;i++){results=results.concat(_getNormalizedLocations(localitzacio[i]));}
localitzacio=results;}}else{}}else{if(localitzacio instanceof ol.Feature){localitzacio=localitzacio.getGeometry();}
if(localitzacio instanceof ol.geom.Geometry){localitzacio=_getGeometryCoords(localitzacio.getCoordinates());}else{localitzacio=[localitzacio];}}
return localitzacio;}
return function(opcions){var olMap=null;var mapCenter=[-9999,-9999];var mapEPSG=DEFAULT_PROJECTION;var mapControls=[];var imiLayers=[];var layerMarcadors=getMarkersLayer();var layerGeometries=getGeometriesLayer();var overAdrStyle=new ol.style.Style({image:new ol.style.Icon(({scale:1,anchorXUnits:'fraction',anchorYUnits:'fraction',anchor:[0.5,1],opacity:1,src:geoBCN.baseURL+'js/'+geoBCN.versions["api"]+'/img/mapa/marker_fort.png'}))});opcions.textes=opcions.textes||geoBCN.Textes.get("mapa");var usrCallbacks={"seleccioAdreca":[],"seleccioFeature":[],"deSeleccioFeature":[],"confirmacioSeleccio":[],"mapClick":[],"mapMove":[],"geoLocalitzacio":[],"namespaceCarregat":[]};if(opcions.nameSpace&&!opcions.mapaBlanc){carregaNamespace(opcions.nameSpace);}else{log.warn("no s'ha definit namespace o s'ha demanat l'opcio mapaBlanc, no es carreguen les capes de fons");}
if(!opcions.fons)opcions.fons=["SAT"];else opcions.fons=_normalitzarFons(opcions.fons);if(!opcions.mode)opcions.mode="NAV";if(!opcions.eines)opcions.eines=[];var toolsList=[];var fonsControl=Controls.getControlFons(opcions);var pointerControl=Controls.getControlPointer(opcions);var controlLlegenda=null;var scaleLineControl=new ol.control.ScaleLine({target:jQuery("#rightoverlays")[0]});var popupControl=null;var popupHoverControl=null;var selPointControl=Controls.getControlSeleccioPunt(opcions,function(feature){if(usrCallbacks["seleccioFeature"].length){callHandlers("seleccioFeature",feature);}},function(feature){if(usrCallbacks["deSeleccioFeature"].length){callHandlers("deSeleccioFeature",feature);}},function(activate){});if(opcions.fons.length>1){if(!opcions.llegenda||typeof(opcions.llegenda.fons)==='undefined'||opcions.llegenda.fons){mapControls.push(fonsControl);}}
if(!opcions.llegenda||typeof(opcions.llegenda.capes)==='undefined'||opcions.llegenda.capes){controlLlegenda=Controls.getControlLlegenda(opcions);mapControls.push(controlLlegenda);}
if(opcions.eines.indexOf("ESCALIMETRE")>=0){mapControls.push(scaleLineControl);}
if(opcions.eines.indexOf("SELPOINT")>=0){mapControls.push(selPointControl);toolsList.push(selPointControl);}
if(geoBCN.hasGeolocation){if(opcions.eines.indexOf("GPSNAV")>=0){var geoLocationControl=Controls.getControlGeoLocation(opcions,extent,function(localitzacio,dinsBCN){callHandlers("geoLocalitzacio",localitzacio);if(dinsBCN){if(!usrCallbacks["geoLocalitzacio"].length){afegeixMarcador({"localitzacio":localitzacio,"popup":{html:"<h3>"+geoBCN.getLabel("geolocation.esteuAqui").label+"</h3>"}});centraMapa({"localitzacio":localitzacio,"zoom":5});}}});mapControls.push(geoLocationControl);toolsList.push(geoLocationControl);}}else{if(console){console.warn("GeoBcn no pot crear el control de geolocalització perque aquesta plana està navegant sobre HTTP. Cal que navegui per HTTPS per tal de poder utilitzar aquesta funcionalitat.");}}
if(geoBCN.esMobil){mapControls.push(pointerControl);}else{}
var controlRotacio;if(opcions.eines.indexOf("ROTACIO")>=0){controlRotacio=Controls.getControlRotacio(opcions);mapControls.push(controlRotacio);}
function _normalitzarFons(capes){var hiHaCapesValides=false;var capesValides=[];capes.forEach(function(element){if(configBCN.fonsMapa.map(function(e){return e.codi}).indexOf(element)>=0){hiHaCapesValides=true;capesValides.push(element);}
else{console.warn("S'ha intentat afegir una capa de fons que no existeix al entorn de GeoBCN. Nom de la capa: "+element);}});if(!hiHaCapesValides){console.warn("No s'ha proporcionat cap capa de fons vàlida, es posarà la capa \"BAS\" per defecte");return["BAS"];}
else{return capesValides;}}
function getWMSLayer(opcions){var capaVisible=typeof(opcions.visible)!='undefined'?opcions.visible:true;if(opcions.singleTile){return new ol.layer.Image({opacity:opcions.opacitat,key:opcions.key,name:opcions.nom,visible:capaVisible,source:new ol.source.ImageWMS({url:opcions.url,params:{'LAYERS':opcions.capes,'SRS':mapEPSG}})});}else{return new ol.layer.Tile({opacity:opcions.opacitat,key:opcions.key,name:opcions.nom,visible:capaVisible,source:new ol.source.TileWMS({url:opcions.url,params:{'LAYERS':opcions.capes,'SRS':mapEPSG,'TILED':true}})});}}
function carregaNamespace(namespace){log.debug("Carregant nameSpace: "+namespace);Utils.rest(geoBCN.layersURL+"/"+namespace,[],function(response){if(response.estat=="OK"){for(var i=0,newLayer;newLayer=response.resultats[i];i++){imiLayers.push(newLayer);}
log.debug("nameSpace "+namespace+" carregat");if(usrCallbacks["namespaceCarregat"].length){callHandlers("namespaceCarregat",imiLayers);}}else{log.error("No s'han pogut obtenir les capes del namespace "+namespace);}});}
function doRevGeocodingAdr(coords,coordsED50){popupControl.showPopup({localitzacio:{x:coords[0],y:coords[1],proj:DEFAULT_PROJECTION},html:"<div class=\"loading\">"+geoBCN.getLabel("cerca.solicitantInformacio").label+"</span>"});geoBCN.Cercadors.revGeocodingAdr({"x":coords[0],"y":coords[1],"proj":DEFAULT_PROJECTION,"max":geoBCN.esMobil?1:5,"radi":40,"resultat":function(res){popupControl.setContent(geoBCN.esMobil?res.resultats[0]?{"html":"<span class=\"candidat\">"+res.resultats[0].nomComplet+" ("+res.resultats[0].extraInfo.distancia+"m.)</span>","buttons":[{"text":geoBCN.getLabel("popup.acceptar").label,"className":"accept","callback":function(){if(usrCallbacks["seleccioAdreca"].length){callHandlers("seleccioAdreca",res.resultats[0]);}
popupControl.hidePopup();}}]}:{"html":"<span class=\"candidat\">"+geoBCN.getLabel("cerca.senseCandidats").label+"</span>"}:{dom:getHTMLAdrCandidates(res)})}});}
function doRevGeocodingPar(coords,coordsED50){if(olMap.getView().getZoom()<7)
return;layerGeometries.getSource().clear();layerMarcadors.getSource().clear();popupControl.showPopup({localitzacio:{x:coords[0],y:coords[1],proj:DEFAULT_PROJECTION},html:'<div class="loading">'+geoBCN.getLabel('cerca.solicitantInformacio').label+'</span>'});geoBCN.Cercadors.revGeocodingPar({x:coords[0],y:coords[1],proj:DEFAULT_PROJECTION,resultat:function(res){var parcela=res.resultats[0];if(res.resultats.length>0){popupControl.hidePopup();popupControl.showPopup({localitzacio:{x:(parcela.extensio.xMax+parcela.extensio.xMin)/2,y:parcela.extensio.yMax,proj:DEFAULT_PROJECTION},html:'<div class="loading">Cercant Adreces a la parcel·la '+parcela.id+'</span>'});var feat=afegeixGeometria(parcela.geometria);centraMapa({localitzacio:parcela.localitzacio,extensio:feat.getGeometry().getExtent()});geoBCN.Cercadors.revGeocodingAdr({parcellaId:res.resultats[0].id,resultat:function(resposta){var res=resposta.resultats;var currAdr;var html=getHTMLAdrCandidates(resposta,function(adressa){return adressa.gpl!=='0';});popupControl.setContent(geoBCN.esMobil?res[0]?{"html":"<span class=\"candidat\">"+res[0].nomComplet+" (xxxm.)</span>","buttons":[{"text":geoBCN.getLabel("popup.acceptar").label,"className":"accept","callback":function(){if(usrCallbacks["seleccioAdreca"].length){callHandlers("seleccioAdreca",res[0]);}
popupControl.hidePopup();}}]}:{"html":"<span class=\"candidat\">"+geoBCN.getLabel("cerca.senseCandidats").label+"</span>"}:{dom:html});}});}else{popupControl.setContent({html:'<span class="">No s\'ha trobat cap parcel·la en aquest emplaçament.</span>'});}}});}
function rotaMapa(opcions){olMap.getView().setRotation(opcions.angle*0.0174532925);}
var animacions={"bounce":function(t){var s=7.5625,p=2.75,l;if(t<(1/p)){l=s*t*t;}else{if(t<(2/p)){t-=(1.5/p);l=s*t*t+0.75;}else{if(t<(2.5/p)){t-=(2.25/p);l=s*t*t+0.9375;}else{t-=(2.625/p);l=s*t*t+0.984375;}}}
return l;},"elastic":function(t){return Math.pow(2,-10*t)*Math.sin((t-0.075)*(2*Math.PI)/0.3)+1;}};function centrar(options){return new Promise(function(resolve,reject){var duracio=0;var vista=olMap.getView();var centreCalculat=_calculaCentreMapa({zoom:options.zoom,localitzacio:options.localitzacio,extensio:options.extensio,proj:options.proj},olMap);if(options.animacio){var easing=options.animacio.funcio||animacions[options.animacio.tipus]||undefined;duracio=options.animacio.duracio||2000;var pan=ol.animation.pan({duration:duracio,source:(vista.getCenter()),easing:easing});var animZoom=ol.animation.zoom({duration:duracio,resolution:vista.getResolution(),easing:easing});olMap.beforeRender(pan,animZoom);}
if(centreCalculat.extent){vista.fit(centreCalculat.extent,olMap.getSize(),{padding:options.padding||undefined});}
if(centreCalculat.center){vista.setCenter([centreCalculat.center.x,centreCalculat.center.y]);}
if(centreCalculat.zoom){vista.setZoom(centreCalculat.zoom);}
setTimeout(function(){resolve();},duracio);});}
function centraMapa(opcions){var coords=Utils.projectaCoordenades(opcions.localitzacio.proj,mapEPSG,opcions.localitzacio.x,opcions.localitzacio.y);var vista=olMap.getView();vista.setCenter(coords);if(opcions.zoom){vista.setZoom(opcions.zoom);}else if(opcions.extensio){vista.fit(opcions.extensio,olMap.getSize());vista.setZoom(vista.getZoom()-1);}}
function afegeixMarcador(opcions){var coords=getStandardCoords(opcions.localitzacio);var marcador=new ol.Feature({geometry:new ol.geom.Point([coords.x,coords.y])});if(opcions.urlIcona){opcions.opcionsIcona=opcions.opcionsIcona||{};var iconOptions={src:opcions.urlIcona,opacity:opcions.opcionsIcona.opacitat||1,scale:opcions.opcionsIcona.escalat||1,anchorXUnits:opcions.opcionsIcona.anchorUnits||'fraction',anchorYUnits:opcions.opcionsIcona.anchorUnits||'fraction',anchor:opcions.opcionsIcona.anchor||[0.5,1]};marcador.setStyle(new ol.style.Style({image:new ol.style.Icon(iconOptions)}));}
layerMarcadors.getSource().addFeature(marcador);if(opcions.popup){popupControl.showPopup({localitzacio:coords,html:opcions.popup.html,offsetY:-35,onClose:function(){if(marcador&&marcador.getId()&&layerMarcadors.getSource().getFeatureById(marcador.getId())){layerMarcadors.getSource().removeFeature(marcador);}}});}
return marcador;}
function afegeixGeometria(geometria){var geom;if(geometria.type==='MultiPolygon'){geom=new ol.Feature({geometry:new ol.geom.MultiPolygon(geometria.coordinates)});}else{geom=new ol.Feature({geometry:new ol.geom.Polygon(geometria.coordinates)});}
layerGeometries.getSource().addFeature(geom);return geom;}
function esborraMarcador(marcador){try{layerMarcadors.getSource().removeFeature(marcador);}catch(e){log.warn("No s'ha pogut esborrar el marcador.");}}
function getHTMLAdrCandidates(response,checkCandidateFunction){var divCandidates=Utils.creaElemHTML({tipus:"div"});var ulCandidates=Utils.creaElemHTML({tipus:"ul",className:"adrCandidates"});divCandidates.appendChild(ulCandidates);var i=0,candidat;var r=0;for(i,candidat;candidat=response.resultats[i];i++){var potAfegir=true;if(checkCandidateFunction){potAfegir=checkCandidateFunction.call(this,candidat)}
if(potAfegir){r++;ulCandidates.appendChild(getHTMLCandidate(candidat));}}
if(r==0){ulCandidates.appendChild(Utils.creaElemHTML({tipus:"span",className:"senseCandidates",html:geoBCN.getLabel("cerca.senseCandidats").label}));}
function getHTMLCandidate(candidat){var text=candidat.nomComplet+(candidat.extraInfo&&candidat.extraInfo.distancia?" ("+candidat.extraInfo.distancia+"m.)":"");var liCand=Utils.creaElemHTML({tipus:"li",className:"adrCandidate",html:text});liCand.onclick=function(){if(popupControl){popupControl.hidePopup();}
if(usrCallbacks["seleccioAdreca"].length){callHandlers("seleccioAdreca",candidat);}
layerGeometries.getSource().clear();layerMarcadors.getSource().clear();};liCand.onmouseover=function(){candidat.marcador=afegeixMarcador({localitzacio:candidat.localitzacio});};liCand.onmouseout=function(){esborraMarcador(candidat.marcador);};return liCand;}
return divCandidates;}
function getJSONLayer(definicio){try{log.debug("Generant Vector source");var urlCapa=null;if(definicio.url){urlCapa=[(definicio.url.indexOf("http")==0?definicio.url:geoBCN.baseURL+definicio.url)+"?","th="+(definicio.threshold||4),"request=GetFeature","TYPENAME="+definicio.nom,"SERVICE=WFS","maxfeatures="+(definicio.maxFeatures||2000),"OUTPUTFORMAT=application/json",(definicio.expiracio?"expiracio="+definicio.expiracio:"")].join("&");log.debug("URL Capa: "+urlCapa);}
var geoJSONFormat=new ol.format.GeoJSON();var sourceParams={format:geoJSONFormat,loader:function(extent,resolution,projection){if(urlCapa){var urlPeticio=urlCapa;if(definicio.strategy=="bbox"){urlPeticio+=["&bbox=",extent.join(","),"&srs="&projection.getCode()].join("");Utils.rest(urlPeticio,null,function(features){vectorSource.addFeatures(geoJSONFormat.readFeatures(features,{featureProjection:projection}));},function(){log.error("Error ajax jsonp vectorSource");});}else{Utils.getJson(urlPeticio.split('?')[0],function(features){vectorSource.addFeatures(geoJSONFormat.readFeatures(features,{featureProjection:projection}));},function(){log.error("Error ajax vectorSource");});}}else{vectorSource.addFeatures(geoJSONFormat.readFeatures(definicio.json));}},projection:definicio.proj};if(definicio.strategy=="bbox"){sourceParams.strategy=ol.loadingstrategy.tile(new ol.tilegrid.createXYZ({maxZoom:definicio.maxZoomLevel,tileSize:definicio.tileSize||512}));}
var vectorSource=new ol.source.Vector(sourceParams);}catch(ex){log.error("Error generant vectorSource",ex);}
log.debug("Vector source generat");try{log.debug("Generant capa");var defCapa={source:vectorSource,key:definicio.codi,visible:definicio.activada!='undefined'?definicio.activada:true,type:"vector",name:definicio.titol,zIndex:definicio.zIndex?definicio.zIndex:0,style:definicio.style||function(feature,resolution){return styleFunction(feature,resolution,definicio.estils);},opacity:definicio.opacity||1,estils:definicio.estils};definicio.minResolution!='undefined'?defCapa.minResolution=definicio.minResolution:null;definicio.maxResolution!='undefined'?defCapa.maxResolution=definicio.maxResolution:null;var vector=new ol.layer.Vector(defCapa);vectorSource.on("addfeature",function(event){event.feature.layer=vector;});return vector;}catch(ex){log.error("Error creant vector",ex);}}
function handleMapEvents(map){map.on('singleclick',function(evt){var coords=Utils.projectaCoordenades(DEFAULT_PROJECTION,"EPSG:23031",evt.coordinate[0],evt.coordinate[1]);log.debug(evt.coordinate[0]+","+evt.coordinate[1]);log.debug(coords[0]+","+coords[1]);if(opcions.mode.indexOf("ADR")>=0&&!geoBCN.esMobil){doRevGeocodingAdr(evt.coordinate,coords);}else if(opcions.mode.indexOf("PAR")>=0&&!geoBCN.esMobil){doRevGeocodingPar(evt.coordinate,coords);}
if(usrCallbacks["mapClick"].length)callHandlers("mapClick",evt);});map.on('moveend',function(evt){var centerXY=evt.map.getView().getCenter();if(mapCenter[0]!=centerXY[0]&&mapCenter[1]!=centerXY[1]){var coords=Utils.projectaCoordenades(DEFAULT_PROJECTION,"EPSG:23031",centerXY[0],centerXY[1]);if(opcions.mode.indexOf("ADR")>=0&&geoBCN.esMobil){doRevGeocodingAdr(centerXY,coords);}else if(opcions.mode.indexOf("PAR")>=0&&geoBCN.esMobil){doRevGeocodingPar(centerXY,coords);}
if(usrCallbacks["mapMove"].length){callHandlers("mapMove",evt);}}
mapCenter=centerXY;});}
function handleInitialEvents(opcions){if(opcions.seleccioAdreca){addHandler("seleccioAdreca",opcions.seleccioAdreca);}
if(opcions.mapClick){addHandler("mapClick",opcions.mapClick);}
if(opcions.mapMove){addHandler("mapMove",opcions.mapMove);}
if(opcions.geoLocalitzacio){addHandler("geoLocalitzacio",opcions.geoLocalitzacio);}
if(opcions.seleccioFeature){addHandler("seleccioFeature",opcions.seleccioFeature);}
if(opcions.deSeleccioFeature){addHandler("deSeleccioFeature",opcions.deSeleccioFeature);}
if(opcions.confirmacioSeleccio){addHandler("confirmacioSeleccio",opcions.confirmacioSeleccio);}
if(opcions.namespaceCarregat){addHandler("namespaceCarregat",opcions.namespaceCarregat);}}
function addHandler(eventName,handler){if(typeof(handler)=='function'){usrCallbacks[eventName].push(handler);}else{throw"El handler ha de ser una funció per obtenir el retorn.";}}
function callHandlers(eventName,eventParams){for(var i=0,eventHandler;eventHandler=usrCallbacks[eventName][i];i++){window.setTimeout(function(obj){try{obj.handler(obj.params);}catch(err){log.warn("Error al cridar handler per "+eventName,err);}},5,{handler:eventHandler,params:eventParams});}}
var paramsRequerits={"divId":{"regexp":"\\S"}};if(!Utils.checkParametres(opcions,paramsRequerits)){throw"Paràmetres incorrectes. Falta divId";}else{olMap=creaMapa(opcions);popupHoverControl=Controls.getControlPopupWeb(olMap);popupControl=geoBCN.esMobil?Controls.getControlPopup(opcions):Controls.getControlPopupWeb(olMap);if(geoBCN.esMobil){olMap.addControl(popupControl);}
for(var i=0,ctrl;ctrl=mapControls[i];i++){olMap.addControl(ctrl)}
handleMapEvents(olMap);handleInitialEvents(opcions);olMap.addLayer(layerGeometries);olMap.addLayer(layerMarcadors);for(var i=1;i<toolsList.length;i++){var left=0;var prevStyle=window.getComputedStyle(toolsList[i-1].element);left=parseInt(prevStyle.right.replace('px',''))+parseInt(prevStyle.width.replace('px',''));toolsList[i].element.style.right=(left+8)+'px';}
jQuery('.ol-zoom.ol-control').addClass("geobcn-tool");setTimeout(function(){controlRotacio;},500);return{mapControls:mapControls,fonsActiu:opcions.fons,olMap:olMap,centraMapa:function(opcions){var paramsRequerits={"localitzacio.x":{"regexp":"[0-9]\.?[0-9]?"},"localitzacio.y":{"regexp":"[0-9]\.?[0-9]?"}};if(Utils.checkParametres(opcions,paramsRequerits)){centrar(opcions);}else{throw"Paràmetres incorrectes";}},centrar:centrar,getStandardCoords:function(coords){return getStandardCoords(coords);},esborraMarcador:function(marcador){esborraMarcador(marcador);},disableMouseWheel:function(){olMap.getInteractions().forEach(function(interaction){if(interaction instanceof ol.interaction.MouseWheelZoom){interaction.setActive(false);}},this);},enableMouseWheel:function(){olMap.getInteractions().forEach(function(interaction){if(interaction instanceof ol.interaction.MouseWheelZoom){interaction.setActive(true);}},this);},afegeixControl:function(control){olMap.addControl(control);},afegeixMarcador:function(opcions){return afegeixMarcador(opcions);},rotaMapa:function(opcions){var paramsRequerits={"angle":{"regexp":"^((0?[0-9]?[0-9]|[1-2][0-9][0-9]|3[0-5][0-9]|36[0])(\.[0-9]*)?)$"}};if(Utils.checkParametres(opcions,paramsRequerits)){rotaMapa(opcions);}else{throw"Paràmetres incorrectes";}},redraw:function(){return redraw(olMap);},CapaVector:function(definicio){var newLayer=getJSONLayer(definicio);olMap.addLayer(newLayer);log.debug("Capa vector afegida");return{"activada":true,"activa":function(){this.activada=true;newLayer.setVisible(true);if(controlLlegenda)controlLlegenda.setLayerVisibility(newLayer.get("key"),true);},"desactiva":function(){this.activada=false;newLayer.setVisible(false);if(controlLlegenda)controlLlegenda.setLayerVisibility(newLayer.get("key"),false);},"extensio":function(){return newLayer.getSource().getExtent();},"features":function(){return newLayer.getSource().getFeatures();}};},CapaWMS:function(opcions){var paramsRequerits={"url":{"regexp":"^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_\+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?"},"nom":{"regexp":"\\S"},"capes":{"regexp":"\\S"}};if(Utils.checkParametres(opcions,paramsRequerits)){opcions.key=opcions.key||"layer"+olMap.getLayers().getLength();var newLayer=getWMSLayer(opcions);olMap.addLayer(newLayer);return{"layerKey":opcions.key,"setVisible":function(visible){newLayer.setVisible(visible);},"activa":function(){newLayer.setVisible(true);},"desactiva":function(){newLayer.setVisible(false);}};}else{throw"Paràmetres incorrectes";}},CapaTile:function(opcions){var capaVisible=typeof(opcions.visible)!='undefined'?opcions.visible:true;var capaTile=getBaseLayer(opcions,capaVisible);olMap.addLayer(capaTile);return capaTile;},CapaTileZXY:function(configLayer){try{var capaVisible=typeof(configLayer.visible)!='undefined'?configLayer.visible:true;var projection=new ol.proj.Projection({code:DEFAULT_PROJECTION,units:'m'});projection.setExtent(configLayer.extent);var tileGrid=new ol.tilegrid.TileGrid({origin:[configLayer.origenX,configLayer.origenY],extent:configLayer.extent,resolutions:configLayer.resolucions});log.debug("Abans del CapaTile crear");var capaTile=new ol.layer.Tile({title:configLayer.nom_capa,id:configLayer.id_capa,isBaseLayer:true,visible:capaVisible,maxResolution:configLayer.maxResolution,source:new ol.source.TileImage({tileUrlFunction:function(tileCoord,pixelRatio,projection){var z=tileCoord[0];var x=tileCoord[1];var y=-tileCoord[2]-1;var n=Math.pow(2,z+1);x=x%n;if(x*n<0){x=x+n;}
return configLayer.url.replace('{z}',z.toString()).replace('{y}',y.toString()).replace('{x}',x.toString());},projection:projection,tileGrid:tileGrid}),});log.debug("Despres del CapaTile crear");olMap.addLayer(capaTile);}catch(err){log.error("Error al afegir CapaTile  ",err);}
return capaTile;},setMode:function(mode){if(Utils.checkValorParametre(mode,"^NAV$|^ADR$|^PAR$|^SEL$")){log.info("Mode:"+mode);opcions.mode=mode;if((mode.indexOf("ADR")>=0||mode.indexOf("PAR")>=0)&&geoBCN.esMobil){pointerControl.showPointer();}else{popupControl.hidePopup();pointerControl.hidePointer();}}else{throw"Mode de mapa incorrecte";}},estableixFons:function(fons){if(opcions.fons.indexOf(fons)>=0){this.fonsActiu=fons;olMap.getLayers().forEach(function(layer){if(layer.get("id")&&["SAT","BAS","PAR","GUIA","PIU","PIU2","PGM","QUAL"].indexOf(layer.get("id")>=0)){log.debug("Desactivant layer"+layer.get("id"));layer.setVisible(fons.indexOf(layer.get("id"))>=0);}});if(fonsControl)fonsControl.estableixFons(fons);}else{log.error("No es pot establir un fons no definit a la inicialització");}},amagaPopup:function(){popupControl.hidePopup();},mostraPopup:function(opcions){opcions.localitzacio=getStandardCoords(opcions.localitzacio);popupControl.showPopup(opcions);},amagaHoverPopup:function(){popupHoverControl.hidePopup();},mostraHoverPopup:function(opcions){opcions.localitzacio=getStandardCoords(opcions.localitzacio);popupHoverControl.showPopup(opcions);},carregaNamespace:function(namescpace){carregaNamespace(namesPace);},seleccioAdreca:function(handler){addHandler("seleccioAdreca",handler);},mapClick:function(handler){addHandler("mapClick",handler);},mapMove:function(handler){addHandler("mapMove",handler);},geoLocalitzacio:function(handler){addHandler("geoLocalitzacio",handler);},seleccioFeature:function(handler){addHandler("seleccioFeature",handler);},deSeleccioFeature:function(handler){addHandler("deSeleccioFeature",handler);},confirmacioSeleccio:function(handler){addHandler("confirmacioSeleccio",handler);},namespaceCarregat:function(handler){addHandler("namespaceCarregat",handler);},donaNivellZoom:function(){return olMap.getView().getZoom();},get:function(key){if(key=="zoom"){return olMap.getView().getZoom();}
else if(key=="mode"){return opcions.mode;}
else if(key=="fons"){return this.fonsActiu;}},set:function(props){if(props.mode){var mode=props.mode;if(Utils.checkValorParametre(mode,"^NAV$|^ADR$|^PAR$|^SEL$")){log.info("Mode:"+mode);opcions.mode=mode;if((mode.indexOf("ADR")>=0||mode.indexOf("PAR")>=0)&&geoBCN.esMobil){pointerControl.showPointer();}else{popupControl.hidePopup();pointerControl.hidePointer();}}else{throw"Mode de mapa incorrecte";}}
if(props.zoom!==undefined){olMap.getView().setZoom(props.zoom);}
if(props.fons){var fons=props.fons;if(opcions.fons.indexOf(fons)>=0){this.fonsActiu=fons;olMap.getLayers().forEach(function(layer){if(layer.get("id")&&["SAT","BAS","PAR","GUIA","PIU","PIU2","PGM","QUAL"].indexOf(layer.get("id")>=0)){log.debug("Desactivant layer"+layer.get("id"));layer.setVisible(fons.indexOf(layer.get("id"))>=0);}});if(fonsControl)fonsControl.estableixFons(fons);}else{log.error("No es pot establir un fons no definit a la inicialització");}}}};}}});