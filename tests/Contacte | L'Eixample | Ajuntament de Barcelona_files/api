
define(["jquery-private","proj4"],function(jQuery,Proj4js){proj4=Proj4js;css=[];var log=geoBCN.log4js.getLogger("utils");if(geoBCN.trace)log.setLevel(log4javascript.Level.TRACE);log.addAppender(geoBCN.logAppender);log.debug("init module");function defineProjections(){log.debug("Definint les projeccions");Proj4js.defs('EPSG:25831','+proj=utm +zone=31 +ellps=GRS80 +units=m +no_defs');Proj4js.defs('EPSG:4326','+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs');Proj4js.defs('EPSG:23031','+title=ED50 / UTM zone 31N +proj=utm +zone=31 +ellps=intl +units=m +towgs84=-87,-98,-121,0,0,0,0');}
var restAccept="application/json+v"+geoBCN.versions["api"]+"+"+(configBCN.LANG?configBCN.LANG:"ca");defineProjections();return{"rest":function(url,params,success,error){log.trace("Cerca rest: "+geoBCN.serviceURL+url);var datatype=url.indexOf(document.location.protocol+"//"+document.location.host)?"jsonp":"json";return jQuery.ajax({url:url,data:params?params:[],dataType:datatype,accept:'application/json, text/javascript',cache:true,ifModified:true,type:"GET",success:function(data){if(success)success(data);},error:function(jqXHR,textStatus,errorThrown){log.error('Error rest url : '+textStatus,errorThrown);if(error)error.call(jqXHR,textStatus,errorThrown);}});},getJson:function(url,success,error){log.trace('getting json: '+url);jQuery.ajax({url:url,dataType:'json',accept:'application/json, text/javascript',type:'GET',cache:true,ifModified:true,success:function(data){if(success)success(data);},error:function(jqXHR,textStatus,errorThrown){log.error('Error getting url : '+textStatus,errorThrown);if(error)error.call(jqXHR,textStatus,errorThrown);}});},"loadCSS":function(cssURL,cssId,cssScope,force){var link=document.getElementById(cssId);if(!css[cssURL]||force){if(!link){link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=geoBCN.baseURL+cssURL;if(cssId)link.id=cssId;document.getElementsByTagName("head")[0].appendChild(link);log.info("css loaded: "+cssURL);css[cssURL]=1;if(cssScope)jQuery("body").addClass(cssScope);}else{log.debug("Canviem la url del css");link.href=geoBCN.baseURL+cssURL;}}else{log.debug("css ja afegit");}},"checkParametres":function(paramsUsr,paramsReq){for(var obligatori in paramsReq){if(obligatori.indexOf(".")<0){if(!paramsUsr[obligatori]){log.error("Falta el paràmetre obligatori "+obligatori);return false;}
if(paramsReq[obligatori].regexp){if(!(paramsUsr[obligatori]+"").match(new RegExp(paramsReq[obligatori].regexp))){log.error("Valor de paràmetre "+obligatori+" erroni");return false;}}
if(paramsReq[obligatori].typeOf){if(typeof(paramsUsr[obligatori])!=paramsReq[obligatori].typeOf){log.error("Tipus del paràmetre "+obligatori+" erroni");return false;}}}}
return true;},"checkValorParametre":function(valor,regexp){return(valor+"").match(new RegExp(regexp));},"creaElemHTML":function(opcions){var htmlElem=document.createElement(opcions.tipus);if(opcions.className)htmlElem.className=opcions.className;if(opcions.id)htmlElem.id=opcions.id;if(opcions.html)htmlElem.innerHTML=opcions.html;if(opcions.title)htmlElem.title=opcions.title;return htmlElem;},"mapResults":function(resultats,fnMap){return jQuery.map(resultats,fnMap);},"geoLocalitza":function(callback){log.info("Inciant localització de navegador");if(navigator.geolocation){navigator.geolocation.getCurrentPosition(callback);}else{log.error("El navegador no soporta geolocalització");}},"projectaCoordenades":function(epsgOrigen,epsgDesti,coordX,coordY){var origTresor=epsgOrigen.indexOf("TRESOR")>=0;var destTresor=epsgDesti.indexOf("TRESOR")>=0;try{if((epsgOrigen&&epsgDesti)&&(epsgOrigen!=epsgDesti)){var src=new Proj4js.Proj(origTresor?"EPSG:23031":epsgOrigen);var dst=new Proj4js.Proj(destTresor?"EPSG:23031":epsgDesti);var coordsOrig=origTresor?tresor2ED50([coordX,coordY]):[coordX,coordY];var point=Proj4js.toPoint([coordsOrig[0],coordsOrig[1]]);Proj4js.transform(src,dst,point);log.trace("trans -> x:"+point.x+" y:"+point.y);return destTresor?ED502Tresor([point.x,point.y]):[point.x,point.y];}else{log.trace("      "+epsgDesti+" --> x:"+coordX+" y:"+coordY);return[coordX,coordY];}}catch(exc){log.error("Error reprojectant coordenades de '"+epsgOrigen+"' a '"+epsgDesti+"' : "+exc.message,exc);}
function ED502Tresor(arrCoords){return[((parseFloat(arrCoords[0])-400000)*1000),((parseFloat(arrCoords[1])-4500000)*1000)];}
function tresor2ED50(arrCoords){return[((parseFloat(arrCoords[0]/1000)+400000)),((parseFloat(arrCoords[1]/1000)+4500000))];}},"projectaLocalitzacio":function(localitzacio,epsgDesti){try{if((localitzacio&&epsgDesti)&&(localitzacio.proj!=epsgDesti)){var coords=this.projectaCoordenades(localitzacio.proj,epsgDesti,localitzacio.x,localitzacio.y);return{"x":coords[0],"y":coords[1],"proj":epsgDesti};}}catch(exc){log.error("Error reprojectant localització.",exc);}
return localitzacio;},"projectaBounds":function(epsgOrigen,epsgDesti,bounds){try{log.trace("o:"+epsgOrigen+" d:"+epsgDesti+" bounds:"+bounds.join("|"));var ptMin=this.projectaCoordenades(epsgOrigen,epsgDesti,bounds[0],bounds[1]);var ptMax=this.projectaCoordenades(epsgOrigen,epsgDesti,bounds[2],bounds[3]);return[ptMin[0],ptMin[1],ptMax[0],ptMax[1]];}catch(excp){log.error("Error reprojectant bounds.",excp);}}}});