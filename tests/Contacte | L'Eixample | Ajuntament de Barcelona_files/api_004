
define(["OpenLayers","jquery-private",geoBCN.baseFiles+"utils"+geoBCN.suffix+".js"],function(ol,jQuery,Utils){var log=geoBCN.log4js.getLogger("controls");log.addAppender(geoBCN.logAppender);if(geoBCN.trace)log.setLevel(log4javascript.Level.TRACE);log.debug("init module");function styleFunction(feature,resolution,customStyle){customStyle=customStyle||{'seleccio':{}};customStyle.seleccio=customStyle.seleccio||{};var lineStringColor=customStyle.seleccio.colorLinea||'#0099ff';var lineStringWidth=customStyle.seleccio.gruixLinea||3;var polygonColor=customStyle.seleccio.colorLinea||'#0099ff';var polygonWidth=customStyle.seleccio.gruixLinea||3;var polygonFill=customStyle.seleccio.colorEmplenat||'rgba(255,255,255, 0.5)';var polygonColor=customStyle.seleccio.colorLinea||'#0099ff';var polygonWidth=customStyle.seleccio.gruixLinea||3;var polygonFill=customStyle.seleccio.colorEmplenat||'rgba(255,255,255, 0.5)';var geomCollectionColor=customStyle.seleccio.colorLinea||'0099ff';var geomCollectionWidth=customStyle.seleccio.gruixLinea||3;var geomCollectionFill=customStyle.seleccio.colorEmplenat||'0099ff';var circleColor=customStyle.seleccio.colorLinea||'0099ff';var circleWidth=customStyle.seleccio.gruixLinea||3;var circleFill=customStyle.seleccio.colorEmplenat||'rgba(255,255,255, 0.5)';var pointColor=customStyle.seleccio.colorLinea||'0099ff';var pointWidth=customStyle.seleccio.gruixLinea||20;var pointFill=customStyle.seleccio.colorEmplenat||'rgba(255,255,255, 0.5)';var styles={'LineString':[new ol.style.Style({stroke:new ol.style.Stroke({color:lineStringColor,width:lineStringWidth})})],'MultiLineString':[new ol.style.Style({stroke:new ol.style.Stroke({color:lineStringColor,width:lineStringWidth})})],'MultiPolygon':[new ol.style.Style({stroke:new ol.style.Stroke({color:polygonColor,width:polygonWidth}),fill:new ol.style.Fill({color:polygonFill})})],'Polygon':[new ol.style.Style({stroke:new ol.style.Stroke({color:polygonColor,width:polygonWidth}),fill:new ol.style.Fill({color:polygonFill})})],'GeometryCollection':[new ol.style.Style({stroke:new ol.style.Stroke({color:geomCollectionColor,width:geomCollectionWidth}),fill:new ol.style.Fill({color:geomCollectionFill}),image:new ol.style.Circle({radius:10,fill:null,stroke:new ol.style.Stroke({color:geomCollectionColor})})})],'Circle':[new ol.style.Style({stroke:new ol.style.Stroke({color:circleColor,width:circleWidth}),fill:new ol.style.Fill({color:circleFill})})],'Point':[new ol.style.Style({stroke:new ol.style.Stroke({color:pointColor,width:pointWidth}),fill:new ol.style.Fill({color:pointFill})})]};return styles[feature.getGeometry().getType()];}
return{"getControlRotacio":function(options){var controlRotacio=function(options){var this_=this;var mapSize;var Container=geoBCN.Utils.creaElemHTML({tipus:"div",className:"control-rotacio"});var rotationSlider=function(rotationChangeListener){var this_=this;var canvasWidth=128;var canvasHeight=128;this.canvas=creaCanvas();this.tornaInicial=creaTornarInicial();var ctx=this.canvas.getContext("2d");var canvasOffset=findPos(this.canvas);var offsetX=canvasOffset.offsetX;var offsetY=canvasOffset.offsetY;var startX;var startY;var isDown=false;var cx=canvasWidth/2;var cy=canvasHeight/2;var w,h;var r=0;var rose=new Image();rose.onload=function(){w=rose.width/4;h=rose.height/4;this_.draw();}
rose.src=geoBCN.baseURL+"js/"+geoBCN.versions.api+"/img/rosa-high.png";var showLight=false;this.reCalculaMides=function(){canvasOffset=findPos(this.canvas);offsetX=canvasOffset.offsetX;offsetY=canvasOffset.offsetY;w=rose.width/4;h=rose.height/4;}
function creaTornarInicial(){var tornar=document.createElement("div");tornar.className="geobcn-rotacio-tornar";tornar.width="15px";tornar.height="15px";Container.appendChild(tornar);var tooltip=document.createElement("div");tooltip.className="animatedBox shadow";tooltip.appendChild(document.createTextNode(geoBCN.getLabel("controlrotacio.tornar").label));Container.appendChild(tooltip);return tornar;}
function creaCanvas(){
  var canvas=document.createElement("canvas");
  canvas.className="geobcn-rotacio";
  canvas.width=canvasWidth;
  canvas.height=canvasHeight;
  Container.appendChild(canvas);
  return canvas;
}
function drawRotationRose(){ctx.save();ctx.translate(cx,cy);ctx.rotate(r);ctx.drawImage(rose,0,0,rose.width,rose.height,-w/2,-h/2,w,h);ctx.restore();}
function drawRotationHandle(withFill){ctx.save();ctx.translate(cx,cy);ctx.rotate(r);ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,-h/2+16,8,0,2*Math.PI,false);ctx.closePath();if(withFill){ctx.fillStyle="#0074f8";ctx.fill();}
ctx.restore();}
function findPos(obj){var curleft=curtop=0;if(obj.offsetParent)
do{curleft+=obj.offsetLeft;curtop+=obj.offsetTop;}while(obj=obj.offsetParent);return{offsetX:curleft,offsetY:curtop};}
function handleMouseDown(e){this_.reCalculaMides();var touchobj=e.changedTouches?e.changedTouches[0]:e;mouseX=parseInt(touchobj.clientX-(offsetX-(document.body.scrollLeft||window.scrollX||window.pageXOffset)));mouseY=parseInt(touchobj.clientY-(offsetY-(document.body.scrollTop||window.scrollY||window.pageYOffset)));this_.mostraLlumeta();isDown=true;}
function handleMouseUp(e){isDown=false;this_.cancelaLlumeta();}
function handleMouseOut(e){isDown=false;this_.cancelaLlumeta();}
function handleMouseMove(e){if(!isDown)return;var touchobj=e.changedTouches?e.changedTouches[0]:e;mouseX=parseInt(touchobj.clientX-(offsetX-(document.body.scrollLeft||window.scrollX||window.pageXOffset)));mouseY=parseInt(touchobj.clientY-(offsetY-(document.body.scrollTop||window.scrollY||window.pageYOffset)));var dx=mouseX-cx;var dy=mouseY-cy;var angle=Math.atan2(dy,dx);r=angle;this_.draw();if(rotationChangeListener)rotationChangeListener(angle+2.35619449);}
this.canvas.onmousedown=function(e){handleMouseDown(e);e.preventDefault();};this.canvas.onmouseup=function(e){handleMouseUp(e);};this.canvas.onmouseout=function(e){handleMouseOut(e);};this.canvas.onmousemove=function(e){handleMouseMove(e);};this.canvas.addEventListener("touchstart",function(e){handleMouseDown(e);},false);this.canvas.addEventListener("touchend",function(e){handleMouseUp(e);},false);this.canvas.addEventListener("touchcancel",function(e){handleMouseUp(e);},false);this.canvas.addEventListener("touchleave",function(e){handleMouseOut(e);},false);this.canvas.addEventListener("touchmove",function(e){handleMouseMove(e);},false);this.mostraLlumeta=function(){this_.timerLLumeta=setInterval(function(){showLight=!showLight;this_.draw()},500);}
this.cancelaLlumeta=function(){clearInterval(this_.timerLLumeta);drawRotationRose();}
this.setRadiants=function(radiants){r=radiants-0.774926188;this_.draw();}
this.draw=function(){ctx.clearRect(0,0,this.canvas.width,this.canvas.height);drawRotationRose();drawRotationHandle(showLight);this_.tornaInicial.style.display=r==0?"none":"inline-block";}};var options=options||{};var angle=0;this.controlId="controlrotacio";this.rotationSlider=new rotationSlider(function(radiants){this_.setMapRotationRad(radiants);});this.rotationSlider.tornaInicial.onclick=function(){this_.setMapRotationRad(0.774926188);};ol.control.Control.call(this,{element:Container,target:null});if(options.rotacio)angle=options.rotacio;this.visible=false;this.setMapRotationRad=function(radiants){if(this_.getMap())this_.getMap().getView().setRotation(radiants);};this.setMapRotation=function(degrees){var rotationOL=degrees*rad2deg;if(this_.getMap())this_.getMap().getView().setRotation(rotationOL);};this.viewChangeListener=function(evt){var radRotation=this_.getMap().getView().getRotation();this_.rotationSlider.setRadiants(radRotation);};this.setMap=function(map){var oldMap=this.getMap();if(oldMap)oldMap.getView().un('change:rotation',this.viewChangeListener,this);if(map)map.getView().on('change:rotation',this.viewChangeListener,this);ol.control.Control.prototype.setMap.call(this,map);this.viewChangeListener();this.rotationSlider.reCalculaMides();};this.showControl=function(){Container.style.display="inline";this.rotationSlider.reCalculaMides();this.visible=true;log.debug("Rotation control ShowControl");}
this.hideControl=function(){Container.style.display="none";this.visible=false;log.debug("Rotation control HideControl");}};ol.inherits(controlRotacio,ol.control.Control);return new controlRotacio(options);},"getControlPopup":function(opcions){var controlPopup=function(){var this_=this;var showing=false;var temporitzador=null;var popupContainer=Utils.creaElemHTML({tipus:"div",className:"popupContainer geobcn-popup"});this.setContent=function(opcions){popupContainer.innerHTML="";if(opcions.html){var infoPupup=Utils.creaElemHTML({tipus:'div',className:'infoPopup',html:opcions.html});if(opcions.buttons){for(var i=opcions.buttons.length-1,btn;btn=opcions.buttons[i];i--){btnDom=Utils.creaElemHTML({tipus:'div',className:'btnPopup'+" "+btn.className,html:btn.text});btnDom.onclick=btn.callback;infoPupup.appendChild(btnDom);}}
popupContainer.appendChild(infoPupup);}else if(opcions.dom){popupContent.appendChild(opcions.dom);}};this.showPopup=function(opcions){if(temporitzador){clearTimeout(temporitzador);}
popupContainer.style.display="block";this.setContent(opcions);if(opcions.timeout){temporitzador=setTimeout(function(){this_.hidePopup()},opcions.timeout);}};this.hidePopup=function(){popupContainer.style.display="none";};ol.control.Control.call(this,{element:popupContainer,target:opcions.target});}
ol.inherits(controlPopup,ol.control.Control);return new controlPopup;},"getControlPopupWeb":function(map){var controlPopup=function(map){var this_=this;var showing=false;var temporitzador=null;var onCloseCallback=null;var popup=Utils.creaElemHTML({tipus:"div",className:'geobcn-popup'});var popupContainer=Utils.creaElemHTML({tipus:"div",className:"ol-popup"});var popupContent=Utils.creaElemHTML({tipus:"div",className:"ol-popup-content",html:""});var popupCloser=Utils.creaElemHTML({tipus:"a",className:"ol-popup-closer"});var popupArrow=Utils.creaElemHTML({tipus:"div",className:"ol-popup-arrow"});popup.appendChild(popupContainer);popup.appendChild(popupArrow);popupContainer.appendChild(popupContent);popupContainer.appendChild(popupCloser);popupCloser.onclick=function(){hidePopup();popupCloser.blur();return false;};var overlay=new ol.Overlay({element:popup});map.addOverlay(overlay);function hidePopup(){if(popup){popup.style.display="none";}
if(typeof(onCloseCallback)=="function"){onCloseCallback(popup);}}
this.onClose=function(onClose){if(onClose){onCloseCallback=onClose;}};this.setContent=function(opcions){if(opcions.html)popupContent.innerHTML=opcions.html;if(opcions.dom){popupContent.innerHTML="";popupContent.appendChild(opcions.dom);}
if(opcions.hideClose){popupCloser.style.display="none";}
else{popupCloser.style.display="block";}};this.showPopup=function(opcions){var projCode=map.getView().getProjection().getCode();if(opcions.onClose){onCloseCallback=opcions.onClose;}
var coords=Utils.projectaCoordenades(opcions.localitzacio.proj,projCode,opcions.localitzacio.x,opcions.localitzacio.y)
overlay.setPosition(coords);if((opcions.offsetX!=null||opcions.offsetX!='undefined')||(opcions.offsetY!=null||opcions.offsetY!='undefined')){log.debug("Aplicant nou offset al tooltip"+opcions.offsetX+" - "+opcions.offsetY);overlay.setOffset([(opcions.offsetX?opcions.offsetX:0),(opcions.offsetY?opcions.offsetY:0)]);}
this.setContent(opcions);popup.style.display="block";};this.hidePopup=function(){hidePopup();};}
return new controlPopup(map);},"getControlPointer":function(opcions){var controlPointer=function(){var this_=this;var pointerContainer=Utils.creaElemHTML({tipus:"div",className:"adrPointer"});ol.control.Control.call(this,{element:pointerContainer,target:opcions.target});this.showPointer=function(){pointerContainer.style.display="block";};this.hidePointer=function(){pointerContainer.style.display="none";};pointerContainer.style.display=(["PAR","ADR"].indexOf(opcions.mode)>=0)?"block":"none";}
ol.inherits(controlPointer,ol.control.Control);return new controlPointer;},"getControlGeoLocation":function(opcions,extent,geoLocationCallback){var controlGeoLocation=function(){var this_=this;var isLocating=false;var geoLocationContainer=Utils.creaElemHTML({tipus:"div",className:"geoLocationContainer geobcn-style geobcn-tool"});var btnGeoLocation=Utils.creaElemHTML({tipus:"button",className:"geoLocation"});geoLocationContainer.appendChild(btnGeoLocation);btnGeoLocation.onclick=function(){if(!isLocating){btnGeoLocation.className+=' localitzant';Utils.geoLocalitza(function(geoPosition){var coords=Utils.projectaCoordenades("EPSG:4326","EPSG:25831",geoPosition.coords.longitude,geoPosition.coords.latitude);var dinsBCN=(coords[0]>=extent[0]&&coords[1]>=extent[1]&&coords[0]<=extent[2]&&coords[1]<=extent[3]);log.debug("Localització del navegador EPSG:25831 :"+coords[0]+" - "+coords[1]-" dinsBCN:"+dinsBCN);var localitzacio={x:coords[0],y:coords[1],proj:"EPSG:25831"};if(geoLocationCallback){geoLocationCallback(localitzacio,dinsBCN);}
btnGeoLocation.className=btnGeoLocation.className.replace(/\localitzant\b/,'');isLocating=false;});}};this.setMap=function(map){ol.control.Control.prototype.setMap.call(this,map);};ol.control.Control.call(this,{element:geoLocationContainer,target:jQuery("#rightoverlays")[0]});}
ol.inherits(controlGeoLocation,ol.control.Control);return new controlGeoLocation;},"getControlSeleccioPunt":function(opcions,selectioCallback,unSelectioCallback,activationCallback){var controlSeleccioPunt=function(){var this_=this;this.active=false;var btnClass="selPunt";var interaction=new ol.interaction.Select({style:function(feature,resolution){var layer=feature.layer||{};return styleFunction(feature,resolution,layer.get("estils"));}});var collection=interaction.getFeatures();collection.on('add',function(feature){selectioCallback(feature)});collection.on('remove',function(feature){unSelectioCallback(feature)});var seleccioPuntContainer=Utils.creaElemHTML({tipus:"div",className:"seleccioPuntContainer geobcn-style geobcn-tool"});var btnSelection=Utils.creaElemHTML({tipus:"button",className:btnClass});seleccioPuntContainer.appendChild(btnSelection);this.setActive=function(isActive){this_.active=isActive;btnSelection.className=btnClass+(this_.active?" active":"")
if(this_.active){this_.getMap().addInteraction(interaction);}else{this_.getMap().removeInteraction(interaction);}
if(activationCallback)activationCallback(this_.active);};btnSelection.onclick=function(){this_.setActive(!this_.active);};ol.control.Control.call(this,{element:seleccioPuntContainer,target:opcions.target});}
ol.inherits(controlSeleccioPunt,ol.control.Control);return new controlSeleccioPunt;},"getControlSeleccioPoligon":function(opcions,selectionCallback,activationCallback){var controlSeleccioPoligon=function(){var this_=this;var active=false;var btnClass="selPoligon";var interaction=new ol.interaction.Draw({type:"Polygon"});interaction.on("drawend",function(){this_.getMap().getLayers().forEach(function(layer){if(layer.get("type")=="vector"){layer.getSource().getFeatures().forEach(function(feature){});}});if(selectionCallback)selectionCallback();},this);var seleccioPoligonContainer=Utils.creaElemHTML({tipus:"div",className:"seleccioPoligonContainer geobcn-style geobcn-tool"});var btnSelection=Utils.creaElemHTML({tipus:"button",className:btnClass});seleccioPoligonContainer.appendChild(btnSelection);this.active=active;this.setActive=function(isActive){active=isActive;btnSelection.className=btnClass+(active?" active":"")
if(activationCallback)activationCallback(active);};btnSelection.onclick=function(){this_.active=!this_.active;btnSelection.className=btnClass+(this_.active?" active":"");if(this_.active){this_.getMap().addInteraction(interaction);}else{this_.getMap().removeInteraction(interaction);}
if(activationCallback)activationCallback(this_.active);};ol.control.Control.call(this,{element:seleccioPoligonContainer,target:opcions.target});}
ol.inherits(controlSeleccioPoligon,ol.control.Control);return new controlSeleccioPoligon;},ajustarDesplegables:function(){if(jQuery(this.legendContainer).length==0){debugger;return;}
var container=jQuery(this.legendContainer);var fons=jQuery(this.fonsContainer);if(container.is(':visible')&&fons.is(':visible')){var left=parseInt(fons.css('right').replace('px',''));container.css({right:20+fons.width()+left});setTimeout(function(){container.css({right:20+fons.width()+left});},500);}},"getControlFons":function(opcions){var _self=this;var controlFons=function(){var this_=this;var showing=false;var capesBase=[];var fonsContainer=Utils.creaElemHTML({tipus:"div",className:"fonsContainer geobcn-style geobcn-dropdown-cont"});_self.fonsContainer=fonsContainer;var showButton=Utils.creaElemHTML({tipus:"div",className:"fonsShowButton geobcn-style geobcn-dropdown"});var fonsDiv=Utils.creaElemHTML({tipus:"div",className:"fons"});fonsContainer.appendChild(showButton);fonsContainer.appendChild(fonsDiv);this.estableixFons=function(fons){var btns=document.getElementsByClassName(opcions.divId+"_cbase");var btnFons=document.getElementById(opcions.divId+"bl_"+fons);for(var i=0,elem;elem=btns[i];i++)elem.className=opcions.divId+"_cbase";if(btnFons)btnFons.className+=" active";if(showButton&&btnFons){showButton.innerHTML=btnFons.innerHTML;_self.ajustarDesplegables();}};var activaCapa=function(clicat){var spl=clicat.id.split("_");var fons=spl[spl.length-1];this_.getMap().getLayers().forEach(function(layer){if(layer.get("id")&&["SAT","BAS","PAR","GUIA"].indexOf(layer.get("id")>=0)){log.debug("Desactivant layer"+layer.get("id"));layer.setVisible(fons.indexOf(layer.get("id"))>=0);}});this_.estableixFons(fons);fonsDiv.style.display="none";showing=false;};var capesFons=function(){var ul=Utils.creaElemHTML({tipus:"ul"});var capaInicial=false;opcions.fons.forEach(function(element){var classActive="";if(!capaInicial){classActive="active";showButton.innerHTML=getCapaByCode(element).nom;capaInicial=true;}
capesBase[element]=Utils.creaElemHTML({tipus:"li",className:opcions.divId+"_cbase "+classActive,id:opcions.divId+"bl_"+element,html:getCapaByCode(element).nom});});for(itm in capesBase){if(capesBase[itm]&&typeof(capesBase[itm])=="object"){capesBase[itm].onclick=function(){activaCapa(this);};ul.appendChild(capesBase[itm])}}
return ul;};function getCapaByCode(codi){for(var i=0,capa;capa=configBCN.fonsMapa[i];i++){if(capa.codi==codi)return capa;}
return{"nom":"desconegut"};}
fonsDiv.appendChild(capesFons());showButton.onmousedown=function(e){log.trace("controlFons showButtonClick");fonsDiv.style.display=showing?"none":"block";showing=!showing;e.preventDefault();};ol.control.Control.call(this,{element:fonsContainer,target:opcions.target});}
ol.inherits(controlFons,ol.control.Control);return new controlFons;},"getControlLlegenda":function(opcions){var _self=this;var controlLlegenda=function(){var this_=this;var showing=false;var legendContainer=Utils.creaElemHTML({tipus:"div",className:"legendContainer geobcn-style geobcn-dropdown-cont"});_self.legendContainer=legendContainer;legendContainer.style.display="none";var showButton=Utils.creaElemHTML({tipus:"div",className:"legendShowButton geobcn-style geobcn-dropdown"});showButton.innerHTML=geoBCN.getLabel("control.Llegenda").label;var legend=Utils.creaElemHTML({tipus:"ul",className:"legend"});legendContainer.appendChild(showButton);legendContainer.appendChild(legend);function layerClick(input){this_.getMap().getLayers().forEach(function(layer){if(layer.get("key")&&layer.get("key").indexOf(input.target.id.substring(4))>=0){log.debug((this.checked?"Activant":"Desactivant")+" layer"+layer.get("key"));layer.setVisible(input.target.checked);}});}
function getLayerHtml(layer){var divContainer=Utils.creaElemHTML({tipus:"li",className:"layer"});var label=Utils.creaElemHTML({tipus:"label",className:"lblayer",html:layer.get("name"),title:layer.get("name")});label.htmlFor="lgn_"+layer.get("key");var input=Utils.creaElemHTML({tipus:"input",className:"imlayer",id:"lgn_"+layer.get("key")});input.type="checkbox";input.checked=layer.getVisible();divContainer.appendChild(input);divContainer.appendChild(label);input.onchange=layerClick;return divContainer;}
var activaCapa=function(clicat){var spl=clicat.id.split("_");var fons=spl[spl.length-1];this_.estableixFons(fons);legend.style.display="none";showing=false;}
this.layerChangeListener=function(evt){if(evt.type.indexOf("add")>=0){if(!evt.element.get('hideAtLegend')){legendContainer.style.display="block";legend.appendChild(getLayerHtml(evt.element))}else{log.info("Layer oculta a la llegenda");}}else if(evt.type.indexOf("remove")>=0){}
_self.ajustarDesplegables();};this.setLayerVisibility=function(codiLayer,visible){var input=document.getElementById("lgn_"+codiLayer);input.checked=visible;};this.setMap=function(map){var oldMap=this.getMap();if(oldMap){var layers=oldMap.getLayers();layers.un('add',this.layerChangeListener);layers.un('remove',this.layerChangeListener);}
if(map){var layers=map.getLayers();layers.on('add',this.layerChangeListener);layers.on('remove',this.layerChangeListener);}
ol.control.Control.prototype.setMap.call(this,map);};showButton.onmousedown=function(e){log.trace("controlLlegenda showButtonClick");legend.style.display=showing?"none":"block";showing=!showing;e.preventDefault();};ol.control.Control.call(this,{element:legendContainer,target:opcions.target});}
ol.inherits(controlLlegenda,ol.control.Control);return new controlLlegenda;}}});